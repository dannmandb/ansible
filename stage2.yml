---

- hosts: all
  become: true
  pre_tasks: 

  - name: update & upgrade repository index
    register: updatesys
    apt:
      update_cache: yes
      upgrade: dist
      cache_valid_time: 3600

  - name: Display the last line of the previous task to check stats
    debug:
      msg: "{{updatesys.stdout_lines|last}}"

- hosts: test_servers
  become: true
  tasks:
  - name: Creates directory
    file:
      path: "{{ item }}"
      state: directory
      owner: daniel
      group: daniel
      mode: 0775
      recurse: yes
    with_items:
      - /opt/appdata/docker/sys/test
      - /opt/appdata/docker/lab/test
      - /srv/www
      - /home/daniel/docker/test

  - name: Ensure docker-compose.yml file.
    template:
      src: /home/daniel/docker/test/docker-compose.yml
      dest: "/home/daniel/docker/test/docker-compose.yml"
      group: docker
      mode: 0775
      backup: yes
      lstrip_blocks: yes
      trim_blocks: yes

  - name: Ensure containers defined in compose file.
    docker_compose:
      project_src: "/home/daniel/docker/test/"
      project_name: "define docker-compose"
      pull: "true"
      state: "present"
      remove_orphans: "true"
    when: not ansible_check_mode
